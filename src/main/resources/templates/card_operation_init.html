<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:score="http://thymeleafexamples">
<head>
  <meta charset="utf-8">
  <meta name=renderer  content=ie-stand>
  <title>卡操作</title>
  <th:block th:replace="head-css.html"></th:block>
</head>
<body>
<div class="row">
<div class="col-md-6">
<div class="box">
<div class="box-header with-border">
	<div class="row">
	<div class="col-md-3">	
    <button id="btn_read_card" class="btn btn-success btn-block" >读卡</button>
	</div>
	<div class="col-md-3">
	<p class="text-muted well well-sm" style="left: 47%; top: -11px; width: 100%; position: absolute;" id="card_status">请读卡</p>
	<!-- <span id="card_status"></span> -->
	</div>
	</div>
</div>
<div class="box-body with-border">
<table class="table table-bordered table-hover" >
	<tr class="success">
		<td colspan="6" align="center">卡信息</td>
		<!-- <td colspan="1" align="center">卡状态</td> -->
		<!-- <td class="info" colspan="2" align="center" style="color:red;" ><marquee id="card_status"></marquee></td> -->
	</tr>
	<tr>
		<td class="success" style="width:15%">卡号</td>
		<td class="info"><span id="cardcode"  ></span></td>
		<td class="success" style="width:15%">卡类型</td>
		<td class="info"><span id="cardtype"></span></td>
		<td class="success" style="width:15%">车辆号牌</td>
		<td class="info"><span id="carno"></span></td>
	</tr>	
	<tr >
		<td class="success">油品类型</td>
		<td  class="info"><span id="oiltype"></span></td>
		<td class="success">记灰标志</td>
		<td  class="info"><span id="grayflag"></span></td>
		<td class="success">记灰日期</td>
		<td  class="info"><span id="graydate"></span></td>		
	</tr>
	<tr>
		<td class="success">卡上余额</td>
		<td  class="info"><span id="balance"></span></td>
		<td class="success">消费次数</td>
		<td  class="info"><span id="tradecounter"></span></td>
		<td class="success">有效期</td>
		<td  class="info"><span id="validdate"></span></td>		
	</tr>
	<tr class="success">
		<td colspan="6" align="center">
		<object id="dukaqi" CLASSID="CLSID:A9C48ED1-F5BB-4E90-B78E-31E076B92838" ></object>
		</td>
	</tr>
</table>
</div>
</div>
</div>

<div class="col-md-6">
<div class="box">
<div class="box-header with-border">
卡初始化
</div> 
<div class="box-body with-border">
<table style="width:100%">
    <tr>
    <td style="width:45%">	
    <label class="radio-inline">
        <input type="radio" name="card_type"  value="0" checked>实物卡
    </label>
    
    <label class="radio-inline">
        <input type="radio" name="card_type"  value="1">价拨卡
    </label>
    <label class="radio-inline">
        <input type="radio" name="card_type"  value="2">参数卡
    </label>   
    </td>
    <td style="width:20%"><input class="form-control" type="text" id="card_no" value="" placeholder="请输入卡号" /></td>
    <td style="width:15%"><input class="form-control" type="text" id="card_password" value="0000" placeholder="请输入密码" disabled/></td>
    <td style="width:20%"><button id="btn_init_card" class="btn btn-block btn-info"  >初始化卡</button></td>
    </tr>
</table>
</div>
</div>
</div>
<div class="col-md-6 ">
<div class="box"> 
<div class="box-header with-border">
卡有效
</div>
<div class="box-body with-border">
<!-- <table>
    <tr>
        td style="width:20%">
            <button id="btn_valid_read_card" class="btn btn-success btn-block" >读卡</button>
        </td>
        <td><input type="text" class="form-control" disabled id="cardno_vaild" value="" placeholder="卡号"/></td>
        <td><input type="text" class="form-control" disabled id="flag_valid" value="" placeholder="有效 标志"/></td>
        <td style="width:20%">
           <button id="btn_valid_card"  class="btn btn-success btn-info" >修改卡有效</button>
        </td>
     </tr>
</table> -->
<button id="btn_valid_card" style="width:20%" class="btn btn-block btn-info" >修改卡有效</button>
</div>
</div>
</div>
<div class="col-md-6">
<div class="box"> 
<div class="box-header with-border">
卡有效期
</div>
<div class="box-body with-border">
<table style="width:40%">
<tr>
	<td style="width:50%">
	<button id="btn_valid_date_card"  class="btn btn-block btn-info" >修改卡有效期</button>
	</td>
	<!-- <td style="width:30%">
	<input type="text" class="form-control" disabled id="cardno_date" value="" placeholder="卡上有效期"/>
	</td> -->
	<td style="width:50%">
	<input type="text" class="form-control" disabled id="valid_date" value="" placeholder="当前有效期"/>
	</td>
</tr>
</table>
<!-- <button id="btn_valid_date_card" style="width:20%" class="btn btn-success " >修改卡有效期</button>
<span><input type="text" class="form-control" disabled id="cardno_date" value="" placeholder="卡上有效期"/></span>
<input type="text" class="form-control" disabled id="valid_date" value="" placeholder="当前有效期"/> -->
<!-- <table>
<tr>
<td style="width:20%">
<button id="btn_valid_date_read_card" class="btn btn-success btn-block" >读卡</button>
</td>
<td>
	<button id="btn_valid_date_card"  class="btn btn-success btn-block" >修改卡有效期</button>
</td>
<td>
	<input type="text" class="form-control" disabled id="cardno_date" value="" placeholder="卡上有效期"/>
</td>
<td>
	<input type="text" class="form-control" disabled id="valid_date"  value="" placeholder="当前有效期"/>
</td>
</tr>
</table> -->
</div>
</div>
</div>
<div class="col-md-6" style="display:none">
<div class="box"> 
<div class="box-header with-border">
卡清除
</div>
<div class="box-body with-border">
<!-- <table style="width:100%"><tr>
    <td style="width:30%"><button id="btn_clear_read_card" class="btn btn-success btn-block" >读卡</button></td>
    <td style="width:40%"><input type="text" class="form-control" disabled id="cardno_clear" value="" placeholder="卡号"/></td>
    <td style="width:30%"><button id="btn_clear_card" class="btn btn-danger btn-block" >清卡</button></td>
</tr></table> -->
<button id="btn_clear_card" style="width:20%" class="btn btn-info btn-block" >清卡</button>
</div>
</div>
</div>
<div class="col-md-6" style="display:none">
<div class="box"> 
<div class="box-header with-border">
卡解灰
<input id="btn_read_gray_card" style="width:10%" type="button" class="btn btn-success " value="读卡"/>
<input id="btn_gray_card" style="width:10%" type="button" class="btn btn-info " value="解灰 " disabled/>
</div>
<div class="box-body with-border">
<table class="table table-bordered   table-striped table-hover" >
	<tr class="info"><td colspan="6" align="center">卡记灰信息</td></tr>
	<tr class="info">
		<td width="10%">卡号</td>
		<td width="20%"><span id="query_cardcode"></span></td>
		<td width="10%">车牌号</td>
		<td width="20%"><span id="query_carno"></span></td>
		<td width="10%">所属部门</td>
		<td width="20%"><span id="query_depart"></span></td>
	</tr>
	<tr class="info">
		<td>油品</td>
		<td ><span id="query_oiltype"></span></td>
		<td>加油量</td>
		<td><span id="query_volumn"></span></td>
		<td>卡余额</td>
		<td><span id="query_balance"></span></td>		
	</tr>
</table>
</div>
</div>
</div>
</div>
<!-- <div class="alert_advance_info alert_advance_info-info alert_advance_info-dismissible">
<button type="button" class="close" data-dismiss="alert_advance_info" aria-hidden="true">&times;</button>
<h4><i class="icon fa fa-info"></i> alert_advance_info!</h4>
<span ></span>
</div> -->
<th:block th:replace="head-js.html"></th:block>
<script type='text/javascript' th:inline="javascript">
var card_status;
function read_card(){
	card_operation(function(flag){
		card_status=flag
		var flaglen=(String(card_status)).length;
		if(flaglen>1){
			clear_card_info()
			//failcounter++;
			$("#card_status").text(card_status)
			alert_advance_warnning(card_status)
			return;
		}
		var card_status=parseInt(flag);		
		switch(card_status){			
			case 0: $("#card_status").text('正常卡');break;
			case 1: $("#card_status").text('没有连接');break;
			case 2: $("#card_status").text('参数卡');break;
			case 3: $("#card_status").text('未初始化卡');break;
			case 4: $("#card_status").text('密码错误');break;
			case 5: $("#card_status").text('初始化卡');break;
			case 6: $("#card_status").text('灰卡');break;
			case 7: $("#card_status").text('无效卡');break;
		}		
		if(card_status==1 || card_status==2 || card_status ==3 ){//不需要读卡			
			return;
		}
		cardcode=dukaqi.readcardinfo(6);
		$("#cardcode").text(cardcode);
		var cardtype=dukaqi.readcardinfo(2);
		switch(cardtype){
		case '0': cardtype='实物卡';break;
		case '1': cardtype='价拨卡';break;
		case '2': cardtype='机动卡';break;
		}
		$("#cardtype").text(cardtype);
		oiltype=dukaqi.readcardinfo(11);
		$("#oiltype").text(oiltype);
		gray_flag=dukaqi.readcardinfo(5);
		var gray_str;
		switch(gray_flag){
		case '0': gray_str='正常卡';break;
		case '3': gray_str='圈存记灰';break;
		case '4': gray_str='加油记灰';break;
		default:gray_str='未知类型';
		}
		$("#grayflag").text(gray_str);
		var gray_datetime=dukaqi.readcardinfo(22);
		gray_datetime=gray_datetime.substr(0,4)+"-"+gray_datetime.substr(4,2)+"-"+gray_datetime.substr(6,2)+" "+gray_datetime.substr(8,2)+":"+gray_datetime.substr(10,2);
		$("#graydate").text(gray_datetime);
		$("#carno").text(dukaqi.readcardinfo(9));
		counter=dukaqi.ReadCardInfo(23);
		balance=dukaqi.ReadCardInfo(25);
		mileage=parseInt(counter)+1;
		$("#balance").text(dukaqi.readcardinfo(21));
		$("#tradecounter").text(dukaqi.readcardinfo(23));
		//console.info(dukaqi.readcardinfo(23))
		validdate=dukaqi.readcardinfo(3);
		//console.info(validdate)
		validdate=validdate.substr(0,4)+"-"+validdate.substr(4,2)+"-"+validdate.substr(6,2);
		//console.info(validdate)
		$("#validdate").text(validdate);
	});
}
$("#btn_read_card").on('click',function(){
	clear_card_info();
	$(this).attr('disabled',true);
	read_card();
	$(this).attr('disabled',false);
});
$("#btn_init_card").on('click',function(){
	$(this).attr('disabled',true);
	card_init();
	$(this).attr('disabled',false);
	
});
//清除卡信息
function clear_card_info(){
	$("#cardcode").text('');
	$("#cardtype").text('');
	$("#carno").text('');
	$("#oiltype").text('');
	$("#grayflag").text('');
	$("#graydate").text('');
	$("#balance").text('');
	$("#tradecounter").text('');
	$("#validdate").text('');
}
//初始化函数 
function card_init(){		
card_operation(function(flag){		
	//alert_advance_info(flag);
	switch(flag){
		case 0: alert_advance_info('正常卡，无法初始化！！！');return;
		//case 1: alert_advance_info('正常卡，无法初始化！！！');return;
		case 2: alert_advance_info('参数卡，无法初始化！！！');return;
		//case 4: alert_advance_info('卡已经发放，无法初始化！！！');return;
		case 6: alert_advance_info('灰卡，无法初始化！！！');return;
		case 7: alert_advance_info('无效卡，无法初始化！！！');return;		
	}
	var card_no=$("#card_no").val();	
	if(card_no.length==0){
		alert_advance_info('输入值为空');
		return;
	}else if(isNaN(card_no)){
		alert_advance_info('请输入数字');
		return;
	}
	var card_password=$("#card_password").val();
	
	var card_type=$("input[name='card_type']:checked").val();
	if(card_type==1){
		dukaqi.InitCard(card_no, card_password);
		var cardcode=dukaqi.ReadCardInfo(6);
		var result="";
		for(var i=0;i<cardcode.length;i++){
			if(i==6)
				result=result+'j';
			else	
				result=result+cardcode[i];
		}
		dukaqi.WriteCardInfo(6,result);
		dukaqi.WriteCardInfo(2,'1');
	}
	else if(card_type==2){
		dukaqi.InitCard(card_no, card_password);
		dukaqi.WriteCardInfo(2,'2');
	}
	else 
		dukaqi.InitCard(card_no, card_password);
	alert_advance_info('初始化成功');
	$("#card_no").val(parseInt(card_no)+1);
	});	
}
//清除卡信息
//清卡 回收 参数卡 发行卡
function card_clear(){
	card_operation(function(flag){
		card_status=flag
		var flaglen=(String(card_status)).length;
		if(flaglen>1){
			clear_card_info()
			//failcounter++;
			$("#card_status").html(card_status)
			alert_advance_info(card_status);
			return;
		}
		var card_status=parseInt(flag);
		switch(card_status){			
			case 0: alert_advance_warnning('正常卡 无法清除');break;
			case 1: alert_advance_warnning('没有连接');break;
			case 2: alert_advance_warnning('参数卡 ');break;
			case 3: alert_advance_warnning('未初始化卡');break;
			case 4: alert_advance_warnning('密码错误 无法清除');break;
			case 5: alert_advance_warnning('初始化卡');break;
			case 6: alert_advance_warnning('灰卡 无法清除');break;
			case 7: alert_advance_warnning('无效卡 无法清除');break;
		}		
		if(card_status==2 || card_status==3 || card_status ==5 ){			
			var result=dukaqi.clearcard('0000');
			if(result==0) alert_advance_info('卡已清除！！！');
			else alert_advance_info('清除操作失败！！！');
		}
	});
}
$("#btn_clear_card").on('click',function(){
	$(this).attr('disabled',true);
	card_clear();
	$(this).attr('disabled',false);
	
});
//有效 
function card_valid(){
card_operation(function(flag){
	//console.info(flag);
	var result;
	if(flag==7){//无效卡
		result=dukaqi.writecardinfo(4,0);
	}else{
		alert_advance_warnning('不是无效卡！！！');
		return;
	}
	if(result==1) alert_advance_info('操作成功，正常卡！！！');
	else alert_advance_warnning('有效操作失败！！！');
});
}
$("#btn_valid_card").on('click',function(){	
	$(this).attr('disabled',true);
	card_valid();
	$(this).attr('disabled',false);
});
//info 修改卡上有效期
$("#btn_valid_date_card").on('click',function(){	
	$(this).attr('disabled',true);
	card_operation(function(flag){		
		card_status=flag
		var flaglen=(String(card_status)).length;
		if(flaglen>1){
			clear_card_info()			
			$("#card_status").html(card_status)
			alert_advance_info(card_status);
			return;
		}
		//console.info(flag);
		var card_status=parseInt(flag);
		switch(card_status){			
			case 0: alert_advance_info('正常卡 ');break;
			case 1: alert_advance_info('没有连接');break;
			case 2: alert_advance_info('参数卡 ');break;
			case 3: alert_advance_info('未初始化卡');break;
			case 4: alert_advance_info('密码错误 ');break;
			case 5: alert_advance_info('初始化卡');break;
			case 6: alert_advance_info('灰卡 ');break;
			case 7: alert_advance_info('无效卡 ');break;
		}		
		if(card_status==0){			
			var cardcode_read=dukaqi.readcardinfo(6);
			var vailddate_read=dukaqi.readcardinfo(3);
			var vailddate=''
			//console.info(cardcode_read+'-'+vailddate_read+'-'+vailddate)
			$.ajax({
				url:'vailddate/query',
				data:{'cardcode':cardcode_read},
				type:'post',
				async:false,
				success:function(data){
					//console.info('后台数据: '+data);
					vailddate=data;
				},
				error:function(xhr){					
					alert_advance_warnning("错误提示： " + xhr.status + " " + xhr.statusText);
				}
			});
			$("#valid_date").val(vailddate);
			vailddate=vailddate.replace(/-/g,"")
			//console.info('准备写卡....... '+vailddate.replace(/-/g,"")+' '+vailddate_read);
			if(vailddate>vailddate_read){
				//console.info(vailddate+' '+vailddate_read);
				var result=dukaqi.writecardinfo(3,vailddate.replace(/-/g,""));
				if(result==1)
					alert_advance_info('success');
				else
					alert_advance_info('failure')
			}else{
				alert_advance_warnning('有效期一致,不需要修改！');
			}
		}
		
		/* var cardcode_read=dukaqi.readcardinfo(6);
		var vailddate=dukaqi.readcardinfo(3);
		valid_date
		if(cardcode==cardcode_read){
			//console.info(cardcode_read+" "+cardcode+" "+vailddate);
			//console.info(vailddate.replace(/-/g,""));替换字符-
			dukaqi.writecardinfo(3,vailddate.replace(/-/g,""));
			alert_advance_info('success');
		}		 */
		
	});
	$(this).attr('disabled',false);
});
</script>
</body>
</html>
