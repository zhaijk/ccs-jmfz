<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:score="http://thymeleafexamples">
<head>
  <meta charset="utf-8">
  <meta name=renderer  content=ie-stand>
  <title>圈存</title>
  <th:block th:replace="head-css.html"></th:block>
</head>
<body>
<div class="box"> 
<div class="box-header with-border">

<input id="btn_read_card" style="width:10%" type="button" class="btn btn-success " value="读卡信息"/>
<input id="btn_quota_card" style="width:10%" type="button" class="btn btn-info " value="圈&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp存" disabled/>
</div>
<div class="box-body with-border">
<div class="row">
<div class="col-md-6">
<table class="table table-bordered   table-striped table-hover" >
	<tr class="success"><td colspan="6" align="center">卡信息</td></tr>
	<tr class="success">
		<td style="width:15%">卡号</td>
		<td><span id="cardcode"></span></td>
		<td style="width:15%">卡类型</td>
		<td><span id="cardtype"></span></td>
		<td style="width:15%">车辆号牌</td>
		<td><span id="carno"></span></td>
	</tr>	
	<tr class="success">
		<td style="width:15%">油品类型</td>
		<td><span id="oiltype"></span></td>
		<td style="width:15%">记灰标志</td>
		<td><span id="sendflag"></span></td>
		<td style="width:15%">记灰日期</td>
		<td><span id="senddate"></span></td>		
	</tr>
</table>
</div>
<div class="col-md-6">
<object id="dukaqi" CLASSID="CLSID:A9C48ED1-F5BB-4E90-B78E-31E076B92838" ></object>
</div>
</div>
</div>
</div>
<div class="box">
<div class="box-body">
<table id="quota_table" class="table table-hover  table-bordered table-condensed">
	<thead>
		<tr style="font-size: 16px; background-color: rgb(237, 241, 244); align: center">
				<th style="width: 6%">序号</th>
				<th style="width: 12%">卡号</th>
				<th style="width: 12%">车牌号</th>
				<th style="width: 8%">发放类型</th>
				<th style="width: 8%">油品类型</th>
				<th style="width: 8%">指标类型</th>
				<th style="width: 8%">发放量</th>
				<th style="width: 8%">发放日期</th>
				<th style="width: 8%">发放次数</th>
				<th style="width: 8%">写卡标志</th>
				<th style="width: 8%">操作员</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</div>
</div>
<th:block th:replace="head-js.html"></th:block>
<script type='text/javascript' th:inline="javascript">
var table,cardcode,sendflag;
//加载数据
function load_data(cardcode,sendflag){
	table=$('#quota_table').DataTable({	
		//'pageLength': 6,
		'bDestroy': 		true,  
		'processing': 		true,
		'searching' : 		false,
		'lengthChange' : 	false,
		/* "select": {
	   	     style: 'single',
	   	        info: false
	   	}, */
	   	"ordering": false, // 禁止排序		
	  	"ajax": {
	        "url": "query_quota_card_trade/datas",
	        "type": "post",
	        "data":{"cardcode":cardcode,"sendflag":sendflag}
	  	},
	  	"columns":[
	  		{ "data": "rn"},
	        { "data": "cardcode" },
	        { "data": "carcode"  },
	        { "data": "guidelineType" },
	        { "data": "oilType" },
	        { "data": "sendType" },
	        { "data": "guidelinecount"},
	        { "data": "provideDate"},
	        { "data": "sendflag"},
	        { "data": "writecard"},
	        { "data": "operator"}
	    ],		
		"oLanguage": { //国际化配置  
			"sProcessing" : "正在获取数据，请稍候...",    
			"sLengthMenu" : "显示 _MENU_ 条",    
			"sZeroRecords" : "没有您要搜索的内容",    
			"sInfo" : "记录数为 _TOTAL_ 条    当前 _PAGE_页",// _PAGE_ _START_ 到  _END_ 条记录 ",    
			"sInfoEmpty" : "记录数为0",    
			"sInfoFiltered" : "(全部记录数 _MAX_ 条)",    
			"sInfoPostFix" : "",    
			"sSearch" : "搜索",
			"sUrl" : "",    
			"oPaginate": {    
				"sFirst" : "首页",    
				"sPrevious" : "<<",    
				"sNext" : ">>",    
				"sLast" : "尾页"    
			}
		}    	
	});	
}
	$("#btn_read_card").on('click',function(){
		$(this).attr('disabled',true);
		card_operation(function(flag){
			cardcode=dukaqi.readcardinfo(6);
			$("#cardcode").text(cardcode);
			$("#cardtype").text(dukaqi.readcardinfo(2));
			$("#oiltype").text(dukaqi.readcardinfo(11));
			sendflag=dukaqi.readcardinfo(8);
			$("#sendflag").text(sendflag);
			$("#senddate").text(dukaqi.readcardinfo(17));
			$("#carno").text(dukaqi.readcardinfo(9));
		});
		$(this).attr('disabled',false);
		//if(table==null)
		load_data(cardcode,sendflag);
		//else{
			//table.fnClearTable();
		//	table.ajax.reload();
		//}
			table.draw(true);
		//console.info(table);
		//if(table.length>0)
		if(table.data().length>0)
			$("#btn_quota_card").attr('disabled',false);
	});
	$("#btn_quota_card").on('click',function(){
		var senddate,guidelinecount;
		$(this).attr('disabled',true);
		card_operation(function(flag){
			console.info(flag);
			if(flag==6){
				alert("灰卡，请处理！！！");
				return;
			}			
			$.ajax({
				url:'query_quota_card_trade/value',
				type:'post',
				data:{"cardcode":cardcode,"sendflag":sendflag},
				success:function(data){
					card_operation(function(flag){
						var card_code=dukaqi.readcardinfo(6);
						var send_flag=dukaqi.readcardinfo(8);					
						//console.info(data.cardcode+" "+data.sendflag+" "+data.guidelinecount)
						//console.info(card_code+" "+data.cardcode)
						if(card_code!=data.cardcode){
							alert('卡号不一致，请放置卡号：'+cardcode);	
							$("#btn_quota_card").attr('disabled',true);
							return ;
						}
						//dukaqi.writecardinfo(5,0);
						//dukaqi.writecardinfo(25,1234);
						dukaqi.writecardinfo(8,data.sendflag);			//发放次数						
						dukaqi.writecardinfo(17,getSystemDate());	//入款日期
						dukaqi.writecardinfo(18,data.guidelinecount);	//发放量
						
						var counter=dukaqi.readcardinfo(23);//消费次数
						counter=parseInt(counter)+1;
						dukaqi.writecardinfo(23,counter);	//发放量
						
						var balance=dukaqi.readcardinfo(21);//读卡余额
						console.info(balance+" "+data.guidelinecount);
						balance=parseFloat(balance)+parseFloat(data.guidelinecount)*100;
						dukaqi.writecardinfo(21,balance);	//写余额
						$.ajax({
							url:'update_quota_card_trade',
							type:'post',
							data:{"cardcode":card_code,"sendflag":send_flag},
							success:function(){								
								alert('圈存操作成功');
								$("#btn_quota_card").attr('disabled',true);
							},
							error:function(xhr){
								alert("错误提示： " + xhr.status + " " + xhr.statusText);
							}
						});
					});
				},
				error:function(xhr){
					alert("错误提示： " + xhr.status + " " + xhr.statusText);
				}
			});
			
		});
		$(this).attr('disabled',false);
		$("#btn_quota_card").attr('disabled',true);
	});
</script>
</body>
</html>
